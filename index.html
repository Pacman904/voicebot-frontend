const fetch = require("node-fetch");

// Cloud-Function: Create an Ephemeral Session with OpenAI
Parse.Cloud.define("createEphemeralSession", async (request) => {
  try {
    const { model, voice } = request.params;
    if (!model || !voice) {
      throw new Error("Missing parameters: model and voice are required");
    }

    // Get OpenAI session data
    const openaiResponse = await fetch("https://api.openai.com/v1/realtime/sessions", {
      method: "POST",
      body: JSON.stringify({ model, voice }),
      headers: {
        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        "Content-Type": "application/json"
      }
    });

    if (!openaiResponse.ok) {
      const errorData = await openaiResponse.json();
      throw new Error(`OpenAI Error: ${errorData.error?.message || "Unknown error"}`);
    }

    const sessionData = await openaiResponse.json();
    console.log("OpenAI Session Data:", sessionData);

    // Save Parse session
    const Session = Parse.Object.extend("Session");
    const parseSession = new Session();
    parseSession.set("clientSecret", sessionData.client_secret.value);
    parseSession.set("iceServers", [
      {
        urls: "stun:stun.relay.metered.ca:80",
      },
      {
        urls: "turn:global.relay.metered.ca:80",
        username: "dabe0db86808a99aa36c7309",
        credential: "n7sdOC9KUqBloUJ4",
      },
      {
        urls: "turn:global.relay.metered.ca:80?transport=tcp",
        username: "dabe0db86808a99aa36c7309",
        credential: "n7sdOC9KUqBloUJ4",
      },
      {
        urls: "turn:global.relay.metered.ca:443",
        username: "dabe0db86808a99aa36c7309",
        credential: "n7sdOC9KUqBloUJ4",
      },
      {
        urls: "turns:global.relay.metered.ca:443?transport=tcp",
        username: "dabe0db86808a99aa36c7309",
        credential: "n7sdOC9KUqBloUJ4",
      }
    ]);
    parseSession.set("openaiSessionId", sessionData.id);
    parseSession.set("model", model);
    parseSession.set("voice", voice);

    const acl = new Parse.ACL();
    acl.setPublicReadAccess(true);
    acl.setPublicWriteAccess(false);
    parseSession.setACL(acl);

    await parseSession.save(null, { useMasterKey: true });

    // Return Parse session ID - KORRIGIERT: Benutze parseSession.id als sessionId
    return {
      sessionId: parseSession.id,
      clientSecret: sessionData.client_secret.value,
      iceServers: parseSession.get("iceServers")
    };
  } catch (error) {
    console.error("Error:", error);
    throw new Error(error.message);
  }
});

// Cloud-Function: Send Signaling Data
Parse.Cloud.define("sendSignalingData", async (request) => {
  try {
    const { sessionId, data } = request.params;
    if (!sessionId || !data) throw new Error("Missing parameters");

    const SignalingData = Parse.Object.extend("SignalingData");
    const signalingData = new SignalingData();
    signalingData.set("sessionId", sessionId);
    signalingData.set("data", data);
    signalingData.set("timestamp", new Date());

    const acl = new Parse.ACL();
    acl.setPublicReadAccess(true);
    acl.setPublicWriteAccess(true);
    signalingData.setACL(acl);

    await signalingData.save(null, { useMasterKey: true });
    return { success: true };
  } catch (error) {
    console.error("Error:", error);
    throw new Error("Could not save signaling data");
  }
});
