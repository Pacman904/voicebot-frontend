<!DOCTYPE html>
<html>
<head>
  <!-- WebRTC Adapter -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.3/adapter.min.js"></script>
  <style>
    /* Styles */
    #voiceBotUI {
      width: 300px;
      height: 400px;
      border: 2px solid #000;
      position: relative;
      font-family: Arial, sans-serif;
    }
    #statusBar {
      height: 30px;
      background: #000;
      color: #ff0000;
      padding: 5px;
      display: none;
    }
    #logContent {
      height: calc(100% - 70px);
      overflow-y: auto;
      padding: 10px;
      background: #f0f0f0;
    }
    #callButton {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    .activeCall {
      background: #ff4444 !important;
    }
    .error {
      color: red;
      font-size: 0.9em;
      margin: 5px 0;
    }
    .bot {
      color: #2c3e50;
      background: #ecf0f1;
      padding: 5px;
      margin: 5px 0;
      border-radius: 3px;
    }
    .user {
      color: #2980b9;
      background: #e8f6fe;
      padding: 5px;
      margin: 5px 0;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div id="voiceBotUI">
    <div id="statusBar"></div>
    <div id="logContent"></div>
    <button id="callButton">Start Call</button>
  </div>
  <script>
    let isCallActive = false;
    let peerConnection;
    let dataChannel;
    let mediaStream;

    const callButton = document.getElementById('callButton');
    const statusBar = document.getElementById('statusBar');
    const logContent = document.getElementById('logContent');

    const voiceRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    voiceRecognition.continuous = true;
    voiceRecognition.interimResults = true;
    voiceRecognition.lang = 'auto';

    callButton.addEventListener('click', async () => {
      isCallActive = !isCallActive;

      if (isCallActive) {
        try {
          activateUI();
          await initVoiceBot();
          startVoiceRecognition();
        } catch (error) {
          handleError(error);
          toggleOff();
        }
      } else {
        toggleOff();
      }
    });

    function activateUI() {
      statusBar.style.display = 'block';
      statusBar.textContent = 'ON AIR';
      callButton.textContent = 'Stop Call';
      callButton.classList.add('activeCall');
    }

    async function initVoiceBot() {
      try {
        // Fetch ICE servers and session data from the Supabase-backed edge function
        const { iceServers, clientSecret } = await fetchIceServersAndSession();

        peerConnection = new RTCPeerConnection({ iceServers });

        const audioElement = new Audio();
        peerConnection.ontrack = (event) => {
          audioElement.srcObject = event.streams[0];
          audioElement.play();
        };

        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaStream.getTracks().forEach(track => peerConnection.addTrack(track));

        dataChannel = peerConnection.createDataChannel("oai-events");
        setupDataChannel();

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        const sdpResponse = await fetch(
          "https://api.openai.com/v1/realtime",
          {
            method: "POST",
            body: JSON.stringify({ sdp: offer.sdp }),
            headers: {
              Authorization: `Bearer ${clientSecret}`,
              "Content-Type": "application/json"
            }
          }
        );

        if (!sdpResponse.ok) {
          throw new Error("Failed to establish connection with OpenAI");
        }

        const answer = await sdpResponse.json();
        await peerConnection.setRemoteDescription({ type: "answer", sdp: answer.sdp });
      } catch (error) {
        throw new Error(`Connection error: ${error.message}`);
      }
    }

    async function fetchIceServersAndSession() {
      const response = await fetch("https://yzknnqjasflrvbzsruvd.supabase.co/functions/v1/create_session");
      if (!response.ok) {
        throw new Error("Failed to fetch session data");
      }
      const data = await response.json();
      return data;
    }

    function setupDataChannel() {
      dataChannel.onmessage = (event) => {
        try {
          const response = JSON.parse(event.data);
          if (response.type === 'response.update') {
            handleBotResponse(response.response.content);
          }
        } catch (error) {
          console.error('Message processing error:', error);
        }
      };
    }

    function handleBotResponse(text) {
      const speech = new SpeechSynthesisUtterance(text);
      speech.lang = 'auto';
      speech.rate = 1.1;
      window.speechSynthesis.speak(speech);

      const messageDiv = document.createElement('div');
      messageDiv.className = 'bot';
      messageDiv.textContent = `${new Date().toLocaleTimeString()}: ${text}`;
      logContent.prepend(messageDiv);
    }

    function startVoiceRecognition() {
      voiceRecognition.start();

      voiceRecognition.onresult = (event) => {
        const transcript = Array.from(event.results)
          .map(result => result[0].transcript)
          .join('');
        if (event.results[0].isFinal && dataChannel?.readyState === 'open') {
          sendUserInput(transcript);
        }
      };
    }

    function sendUserInput(text) {
      const message = {
        type: "response.create",
        response: {
          modalities: ["text"],
          instructions: `
            [User request: ${text}]
            Response rules:
            1. Polite and concise (3-4 sentences)
            2. Source: www.palettix.com
            3. Match user language
            4. No technical details
          `
        }
      };

      dataChannel.send(JSON.stringify(message));

      const userDiv = document.createElement('div');
      userDiv.className = 'user';
      userDiv.textContent = `${new Date().toLocaleTimeString()}: ${text}`;
      logContent.prepend(userDiv);
    }

    function toggleOff() {
      isCallActive = false;
      statusBar.style.display = 'none';
      callButton.textContent = 'Start Call';
      callButton.classList.remove('activeCall');

      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
      }
      if (peerConnection) {
        peerConnection.close();
      }
      if (voiceRecognition) {
        voiceRecognition.stop();
      }
      window.speechSynthesis.cancel();
    }

    function handleError(error) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = `${new Date().toLocaleTimeString()}: ${error.message}`;
      logContent.prepend(errorDiv);
      console.error(error);
    }

    window.addEventListener('error', (event) => {
      handleError(event.error);
    });
  </script>
</body>
</html>
